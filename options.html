<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Trading Analyzer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            padding: 10px;
            max-width: 100%;
            box-sizing: border-box;
        }
        h1 {
            font-size: 1.5em;
            text-align: center;
        }
        p {
            font-size: 1em;
        }
        input, button, select {
            width: 100%;
            max-width: 300px;
            padding: 10px;
            margin: 5px 0;
            font-size: 1em;
            box-sizing: border-box;
        }
        button {
            background-color: #4BC0C0;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #3aa0a0;
        }
        #output, #lookupResults {
            margin-top: 10px;
            font-size: 0.9em;
        }
        .ticker-option {
            cursor: pointer;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .ticker-option:hover {
            background-color: #f0f0f0;
        }
        nav {
            margin: 10px 0;
        }
        @media (max-width: 600px) {
            h1 {
                font-size: 1.2em;
            }
            p, #output, #lookupResults, ul {
                font-size: 0.85em;
            }
            input, button, select {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <nav>
        <a href="index.html"><button>Price Prediction</button></a>
        <a href="advanced_options.html"><button>Advanced Options</button></a>
    </nav>
    <h1>Options Trading Analyzer</h1>
    <p>Enter ticker (e.g., ^SPX, ^XSP), select expiration, spread type, POP (%), and leverage to find profitable vertical spreads.</p>
    <input type="text" id="ticker" placeholder="Ticker (e.g., ^SPX, ^XSP)" value="^SPX" />
    <button onclick="lookupTicker()">Lookup Ticker</button>
    <div id="lookupResults"></div>
    <select id="expiration">
        <option value="">Select expiration date</option>
    </select>
    <select id="spreadType">
        <option value="call">Vertical Call Credit Spread</option>
        <option value="put">Vertical Put Credit Spread</option>
    </select>
    <input type="number" id="pop" placeholder="Probability of Profit (%)" value="57" step="1" min="0" max="100" />
    <input type="number" id="leverage" placeholder="Leverage (e.g., 0.5)" value="0.5" step="0.1" min="0" />
    <button onclick="analyzeSpreads()">Analyze Spreads</button>
    <div id="output"></div>

    <script>
        const PROXY_URL = 'https://cors-anywhere.herokuapp.com/'; // Optional proxy for CORS

        async function lookupTicker() {
            const ticker = document.getElementById('ticker').value.trim().toLowerCase().replace(/[^a-z0-9-^]/g, '');
            const lookupResults = document.getElementById('lookupResults');
            lookupResults.innerHTML = '<p>Searching...</p>';

            if (!ticker) {
                lookupResults.innerHTML = '<p>Please enter a ticker to search.</p>';
                return;
            }

            try {
                let results = [];
                // Hardcoded mapping for SPX and XSP
                if (ticker === 'spx' || ticker === '^spx' || ticker === 'xsp' || ticker === '^xsp') {
                    results.push({
                        ticker: ticker === 'spx' || ticker === '^spx' ? '^SPX' : '^XSP',
                        name: ticker === 'spx' || ticker === '^spx' ? 'S&P 500 Index' : 'Mini-SPX Index',
                        type: 'Index Options'
                    });
                }
                // Add Yahoo Finance search (basic validation)
                const response = await fetchWithRetry(`${PROXY_URL}https://query1.finance.yahoo.com/v7/finance/options/${ticker}`);
                const data = await response.json();
                if (data.optionChain && data.optionChain.result && data.optionChain.result[0]) {
                    results.push({
                        ticker: ticker.toUpperCase(),
                        name: data.optionChain.result[0].quote.regularMarketPrice ? `Index (${ticker.toUpperCase()})` : 'Unknown',
                        type: 'Index Options'
                    });
                }

                if (results.length === 0) {
                    lookupResults.innerHTML = `<p>No results found for "${ticker}". Try ^SPX or ^XSP.</p>`;
                    return;
                }

                lookupResults.innerHTML = `
                    <p><strong>Search Results for "${ticker}":</strong></p>
                    <ul>
                        ${results.map(r => `
                            <li class="ticker-option" onclick="selectTicker('${r.ticker}')">
                                ${r.ticker} - ${r.name} (${r.type})
                            </li>
                        `).join('')}
                    </ul>
                `;
                // Fetch expiration dates for the first valid ticker
                if (results.length > 0) {
                    fetchExpirations(results[0].ticker);
                }
            } catch (error) {
                lookupResults.innerHTML = `<p>Error searching ticker: ${error.message}. Try ^SPX or ^XSP.</p>`;
            }
        }

        function selectTicker(ticker) {
            document.getElementById('ticker').value = ticker;
            document.getElementById('lookupResults').innerHTML = '';
            fetchExpirations(ticker);
        }

        async function fetchExpirations(ticker) {
            const expirationSelect = document.getElementById('expiration');
            expirationSelect.innerHTML = '<option value="">Loading expirations...</option>';

            try {
                const response = await fetchWithRetry(`${PROXY_URL}https://query1.finance.yahoo.com/v7/finance/options/${ticker}`);
                const data = await response.json();
                if (!data.optionChain || !data.optionChain.result || !data.optionChain.result[0]) {
                    expirationSelect.innerHTML = '<option value="">No expirations found</option>';
                    return;
                }

                const expirations = data.optionChain.result[0].expirationDates || [];
                if (expirations.length === 0) {
                    expirationSelect.innerHTML = '<option value="">No expirations available</option>';
                    return;
                }

                expirationSelect.innerHTML = '<option value="">Select expiration date</option>' + 
                    expirations.map(timestamp => {
                        const date = new Date(timestamp * 1000);
                        const dateStr = date.toISOString().split('T')[0];
                        return `<option value="${timestamp}">${dateStr}</option>`;
                    }).join('');
            } catch (error) {
                expirationSelect.innerHTML = `<option value="">Error loading expirations: ${error.message}</option>`;
            }
        }

        async function analyzeSpreads() {
            const ticker = document.getElementById('ticker').value.trim();
            const expirationTimestamp = document.getElementById('expiration').value;
            const spreadType = document.getElementById('spreadType').value;
            const targetPOP = parseFloat(document.getElementById('pop').value) / 100;
            const targetLeverage = parseFloat(document.getElementById('leverage').value);

            if (!ticker || !expirationTimestamp) {
                alert('Please enter ticker and select an expiration date.');
                return;
            }

            const output = document.getElementById('output');
            output.innerHTML = '<p>Loading options chain...</p>';

            try {
                const url = `${PROXY_URL}https://query1.finance.yahoo.com/v7/finance/options/${ticker}?date=${expirationTimestamp}`;
                const response = await fetchWithRetry(url, 3, 2000, {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
                });
                const data = await response.json();

                if (!data.optionChain || !data.optionChain.result || !data.optionChain.result[0]) {
                    throw new Error('No options data found for this ticker and expiration. Try a different date or ticker.');
                }

                const options = data.optionChain.result[0];
                const calls = options.options[0].calls || [];
                const puts = options.options[0].puts || [];

                const chain = spreadType === 'call' ? calls : puts;

                if (chain.length === 0) {
                    throw new Error(`No ${spreadType} options found for this expiration.`);
                }

                const profitableSpreads = [];
                for (let i = 0; i < chain.length - 1; i++) {
                    const shortOption = chain[i];
                    for (let j = i + 1; j < chain.length; j++) {
                        const longOption = chain[j];

                        if (spreadType === 'call' && shortOption.strike >= longOption.strike) continue;
                        if (spreadType === 'put' && shortOption.strike <= longOption.strike) continue;

                        const credit = shortOption.ask - longOption.bid; // Approximate credit received
                        if (credit <= 0) continue;

                        const width = Math.abs(shortOption.strike - longOption.strike);
                        const maxLoss = width - credit;
                        if (maxLoss <= 0) continue;

                        const leverage = credit / maxLoss;

                        // POP approximation: 1 - short delta (using implied volatility as proxy if delta unavailable)
                        const shortDelta = shortOption.impliedVolatility ? shortOption.impliedVolatility : 0.5;
                        const pop = 1 - shortDelta;

                        if (Math.abs(pop - targetPOP) < 0.05 && Math.abs(leverage - targetLeverage) < 0.1) {
                            profitableSpreads.push({
                                shortStrike: shortOption.strike,
                                longStrike: longOption.strike,
                                credit: credit.toFixed(2),
                                maxLoss: maxLoss.toFixed(2),
                                leverage: leverage.toFixed(2),
                                pop: (pop * 100).toFixed(2) + '%'
                            });
                        }
                    }
                }

                if (profitableSpreads.length === 0) {
                    output.innerHTML = `<p>No profitable vertical ${spreadType} spreads found matching POP ≈ ${targetPOP * 100}% and leverage ≈ ${targetLeverage}. Try a different expiration or criteria.</p>`;
                } else {
                    output.innerHTML = `
                        <h2>Profitable Vertical ${spreadType.toUpperCase()} Credit Spreads for ${ticker.toUpperCase()}</h2>
                        <p>Expiration: ${new Date(parseInt(expirationTimestamp) * 1000).toLocaleDateString()}</p>
                        <ul>
                            ${profitableSpreads.map(spread => `
                                <li>
                                    Short Strike: ${spread.shortStrike}, Long Strike: ${spread.longStrike}<br>
                                    Credit: $${spread.credit}, Max Loss: $${spread.maxLoss}<br>
                                    Leverage: ${spread.leverage}, POP: ${spread.pop}
                                </li>
                            `).join('')}
                        </ul>
                    `;
                }
            } catch (error) {
                output.innerHTML = `<p>Error: ${error.message}. Ensure ticker (^SPX, ^XSP) and expiration are valid. Try Lookup or a different date.</p>`;
            }
        }

        async function fetchWithRetry(url, retries = 3, delay = 1000, headers = {}) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, { headers });
                    if (response.status === 429) {
                        await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                }
            }
        }

        // Initialize expirations for default ticker (^SPX)
        window.onload = () => fetchExpirations('^SPX');
    </script>
</body>
</html>